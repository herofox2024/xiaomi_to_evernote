# 小米笔记导出工具 - 优化版本

## 主要改进

### 1. 完善的错误处理和异常管理
- **自定义异常类**: `ValidationError`, `NetworkError` 等专门处理特定类型的错误
- **详细的错误日志**: 每个操作都有对应的日志记录
- **优雅的错误恢复**: 网络请求失败时自动重试机制
- **分类异常处理**: 不同类型的错误有不同的处理策略

### 2. 配置管理系统
- **配置文件支持**: 支持 YAML 格式的配置文件
- **命令行参数覆盖**: 命令行参数可以覆盖配置文件中的设置
- **配置验证**: 启动时自动验证配置的有效性
- **默认配置**: 提供合理的默认配置

### 3. 专业的日志系统
- **多级别日志**: DEBUG, INFO, WARNING, ERROR 级别
- **多输出目标**: 同时支持控制台和文件输出
- **结构化日志**: 统一的日志格式，便于分析
- **日志轮转**: 支持日志文件管理

### 4. 代码结构优化
- **模块化设计**: 将功能分离到不同的类和方法中
- **单一职责**: 每个方法只负责一个具体功能
- **可测试性**: 代码结构更适合单元测试
- **可维护性**: 清晰的代码组织，便于维护和扩展

### 5. 完善的类型提示
- **类型定义**: 使用 `TypedDict` 定义数据结构
- **参数类型**: 所有函数参数和返回值都有类型提示
- **类型安全**: 编译时就能发现类型错误
- **开发体验**: IDE 支持更好，代码提示更准确

### 6. 性能优化
- **并发下载**: 使用线程池并发下载资源文件
- **批量处理**: 优化了资源下载的批量处理逻辑
- **内存管理**: 更好的内存使用，避免大文件占用过多内存
- **进度显示**: 实时进度显示，用户体验更好

### 7. 安全性改进
- **输入验证**: 对 cookies 和用户输入进行严格验证
- **文件名清理**: 自动清理文件名中的非法字符
- **XML 安全**: 防止 XML 注入攻击
- **错误信息**: 避免在错误信息中泄露敏感信息

### 8. 用户体验改进
- **进度条**: 支持 tqdm 进度条显示
- **详细反馈**: 每个操作都有清晰的反馈信息
- **配置向导**: 一键生成默认配置文件
- **中断处理**: 优雅处理用户中断操作

## 使用方法

### 1. 基本使用
```bash
python xiaomi_to_evernote.py --cookies "your_cookies_string"
```

### 2. 使用配置文件
```bash
# 先创建默认配置文件
python xiaomi_to_evernote.py --create-config

# 编辑 config.yaml 文件设置参数

# 使用配置文件
python xiaomi_to_evernote.py --cookies "your_cookies_string"
```

### 3. 命令行参数
```bash
python xiaomi_to_evernote.py \
  --cookies "your_cookies_string" \
  --chunk-size 30 \
  --output-dir "my_notes" \
  --timeout 60 \
  --max-workers 8 \
  --log-level DEBUG \
  --no-progress
```

### 4. 获取 cookies
程序会自动提示如何从浏览器获取 cookies，或者运行：
```bash
python xiaomi_to_evernote.py --cookies ""
```

## 配置文件说明

详细配置选项请参考 `config.yaml` 文件。主要配置项包括：

- `export.chunk_size`: 每批导出的笔记数量
- `export.output_dir`: 输出目录
- `export.timeout`: 请求超时时间
- `export.max_workers`: 并发下载线程数
- `logging.log_level`: 日志级别
- `logging.log_file`: 日志文件路径

## 依赖要求

### 必需依赖
- `requests`: HTTP 请求库
- `PyYAML`: YAML 配置文件支持

### 可选依赖
- `Pillow`: 图片尺寸检测（如果未安装会自动跳过）
- `tqdm`: 进度条显示（如果未安装会使用简单进度显示）

### 安装依赖
```bash
pip install requests PyYAML Pillow tqdm
```

## 错误处理

优化版本提供了更详细的错误信息：

- **网络错误**: 自动重试机制，详细的网络错误日志
- **认证错误**: 清晰的 cookies 验证和错误提示
- **文件错误**: 文件权限、磁盘空间等问题的处理
- **数据错误**: JSON 解析、XML 处理等错误的详细日志

## 日志系统

### 日志级别
- `DEBUG`: 详细的调试信息
- `INFO`: 一般信息（默认）
- `WARNING`: 警告信息
- `ERROR`: 错误信息

### 日志输出
- **控制台**: 实时显示运行状态
- **文件**: 可选的日志文件记录（通过 `log_file` 配置）

### 日志格式
```
2025-11-04 08:42:57 - __main__ - INFO - 开始导出小米笔记...
2025-11-04 08:42:58 - __main__ - INFO - 已设置 5 个cookies
2025-11-04 08:43:01 - __main__ - INFO - 登录状态检查成功
```

## 性能优化

### 并发下载
- 使用 `ThreadPoolExecutor` 并发下载图片等资源
- 可配置的工作线程数（默认 5 个）
- 自动错误恢复和重试机制

### 内存优化
- 分批处理大量笔记，避免内存溢出
- 及时释放不需要的资源
- 优化 XML 文档的创建和保存

### 进度显示
- 实时进度条显示
- 详细的处理状态反馈
- 支持禁用进度条（`--no-progress`）

## 安全性

### 输入验证
- Cookies 格式验证
- 文件名安全清理
- XML 内容转义

### 错误处理
- 不在错误信息中暴露敏感数据
- 安全的异常处理机制
- 详细的调试日志（可选）

## 故障排除

### 常见问题

1. **登录失败**
   - 检查 cookies 是否有效
   - 确认网络连接正常
   - 查看详细错误日志

2. **下载失败**
   - 检查网络连接
   - 增加超时时间
   - 降低并发线程数

3. **文件保存失败**
   - 检查输出目录权限
   - 确认磁盘空间充足
   - 清理文件名中的特殊字符

4. **内存不足**
   - 减小分批大小
   - 关闭其他占用内存的程序
   - 使用更小的并发线程数

### 调试模式
```bash
python xiaomi_to_evernote.py --cookies "your_cookies" --log-level DEBUG
```

## 贡献指南

欢迎提交 Issue 和 Pull Request 来改进这个工具！

### 开发环境设置
```bash
git clone <repository>
cd xiaomi-note-exporter
pip install -r requirements.txt
```

### 代码规范
- 遵循 PEP 8 代码规范
- 添加适当的类型提示
- 编写单元测试
- 更新文档

## 联系方式

- **项目主页**: `https://github.com/herofox2024/xiaomi_to_evernote`
- **问题反馈**: `https://github.com/herofox2024/xiaomi_to_evernote/issues`
- **邮箱**: 42845734@qq.com

## 许可证

本项目采用 MIT 许可证。详见 LICENSE 文件。

## 更新日志

### v1.0.4 (2025-12-19)
- **错误日志优化**：
  - 修复了错误日志没有打印出来的问题
  - 确保日志文件 `xiaomi_export.log` 自动生成
  - 优化日志配置逻辑，支持控制台和文件双重输出
  - 改进日志文件路径处理，使用绝对路径确保可靠性
- **用户体验改进**：
  - 程序报错后不会直接闪退，等待用户确认后才退出
  - 添加了 `按Enter键退出...` 提示，便于查看完整错误信息
  - 完善了错误信息的显示格式
  - 增强了用户交互的友好性
- **日志系统增强**：
  - 确保根日志记录器也配置了文件输出
  - 添加了日志初始化的调试信息
  - 优化了日志文件的创建逻辑
  - 增强了日志系统的鲁棒性

### v1.0.3 (2025-12-19)
- **修复导出400多条笔记闪退问题**：
  - 优化内存管理，添加资源清理机制
  - 改进正则表达式性能，使用非贪婪匹配
  - 优化分块处理逻辑，及时释放资源
  - 增强异常处理，记录完整堆栈信息
  - 添加会话资源自动释放机制
- **性能优化**：
  - 优化资源处理流程，减少字符串操作开销
  - 改进XML文档管理，避免内存泄漏
  - 增强日志记录，便于调试和问题追踪
  - 优化进度显示，提升用户体验

### v1.0.0 (2025-11-04)
- 完整的重构和优化
- 添加配置管理系统
- 改进错误处理和日志系统
- 性能优化和并发支持
- 安全性改进
- 用户体验提升
